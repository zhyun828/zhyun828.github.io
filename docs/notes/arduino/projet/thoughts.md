编码器计数并非由软件定义，而是由编码器硬件结构及其输出脉冲数决定。程序通过 Encoder 库对 A/B 相信号进行解码并累积计数。经实验测得，手动转动驱动轮一圈，编码器计数变化为 12，因此该数值被用于后续角度换算与控制逻辑。
void loop() {
  Serial.println(enc.read());
}
因此，可以通过读取编码器的计数值来确定驱动轮的旋转角度和位置，从而实现精确的运动控制。

首先读取温度数据
将温度数据线性转化为弧度

## 温度读取验证：I2C 能稳定读取温度值
## 编码器验证：确认驱动轮一圈 count=12，方向正负正确
## 为解决校准问题，设计校准动作（r/l/r5/l5）
单步动作验证（r/l/r5/l5）r指令是右转一圈，l指令是左转一圈，数字表示转动圈数
发现PI 控制下，控制难度大导致r/l指令不能准确地到达目标位置
引入pulse-based integral compensation机制，以提高控制精度
设计nudge模式，实现微调功能。最终保证输入r/l 指令后，计数器的误差能控制在±1以内且大部分时候为0
为了实现这个思路需要设计状态机 M_IDLE, M_COARSE_FAST, M_COARSE_SLOW, M_NUDGE_OFF, M_NUDGE_ON
最终用P控制+nudge控制实现了较为满意的校准指令控制效果

设计思路
1. 问题背景与总体目标

本项目旨在设计并实现一种基于电机与编码器的指针式温度显示系统。系统通过温度传感器实时采集环境温度，并驱动电机带动指针旋转，使指针指向与当前温度对应的刻度位置。

由于所采用的电机与传动机构不存在物理上的绝对零位，同时系统存在静摩擦、齿隙和负载不确定性等非理想因素，因此必须采用闭环控制结构，并设计可靠的人工校准机制，以保证系统在长期运行中的准确性和稳定性。

2. 系统功能拆分与总体架构

根据功能需求，将系统划分为以下两个工作层次：

目标生成层

根据温度传感器输出生成期望指针角度

根据人工校准指令（r / l / r5 / l5）生成相对位移目标

位置控制层

以编码器计数（count）作为唯一反馈量

通过闭环控制驱动电机，使实际位置逼近期望位置

该结构使得校准动作与温度跟随动作可以共享同一套位置控制器，仅在目标生成方式上有所区别。

3. 关键验证与问题发现过程
3.1 温度读取验证

首先对温度传感器进行单独验证，确认 Arduino 能够通过 I²C 总线稳定读取温度数据，并正确解析为摄氏度数值，为后续角度映射提供可靠输入。

3.2 编码器验证

在机械系统中，编码器安装于驱动轮轴上。通过实验测得：驱动轮转动一整圈时，编码器计数变化为 12。
同时确认编码器正负方向与物理转动方向一致，为后续位置控制奠定基础。

4. 校准问题与单步动作设计

由于系统不存在绝对零位，必须引入人工校准机制。为此设计了以下校准指令：

r / l：驱动轮正向 / 反向转动 1 圈（±12 count）

r5 / l5：驱动轮正向 / 反向转动 5 圈（±60 count）

这些指令允许用户在 STOP 模式下手动调整指针位置，并通过 sync 指令将当前指针位置定义为正确参考位置，从而建立软件层面的角度偏移量。

5. 控制策略选择与改进
5.1 传统 PI 控制的局限性

在初期尝试中，曾考虑采用 PI 控制以消除稳态误差。然而在实际调试中发现：

编码器分辨率较低，反馈信号为离散计数

系统存在明显静摩擦与齿隙

PWM 存在“能动门槛”，积分项易累积并突然释放

上述因素导致 PI 控制在本系统中难以稳定整定，容易引发振荡和过冲，尤其在 r/l 等单步动作中难以精确到位。

5.2 引入脉冲式积分补偿思想（Nudge）

为解决上述问题，本项目放弃连续积分控制，转而采用**脉冲式积分补偿（pulse-based integral compensation）**的工程策略：

在误差较大时，使用比例控制（P control）快速逼近目标

在误差较小时，采用短时 PWM 脉冲推进（nudge）

每次脉冲后强制断电等待系统停稳，再重新评估误差

该方法在工程效果上等效于积分作用，能够逐步消除稳态误差，同时避免积分饱和和持续振荡。

6. 基于状态机的运动控制设计

为实现上述控制策略，系统设计了一套有限状态机，包含以下状态：

M_IDLE：空闲状态，电机关闭

M_COARSE_FAST：粗调快速逼近状态

M_COARSE_SLOW：粗调慢速逼近状态

M_NUDGE_OFF：断电等待停稳状态

M_NUDGE_ON：脉冲微调推进状态

状态机根据当前误差大小在不同状态之间切换，实现从快速响应到高精度定位的平滑过渡。

7. 控制效果与统一性

通过上述设计，系统最终实现：

r / l / r5 / l5 校准指令后，计数误差稳定控制在 ±1 以内，大多数情况下为 0

同一套状态机与控制逻辑同时适用于：

人工校准（相对位移控制）

温度跟随（绝对位置控制）

两种模式仅在目标生成方式上不同，而底层位置控制器完全统一，保证了系统结构的简洁性与可维护性。

8. 小结

本项目通过将控制重点统一到编码器计数域，并采用基于状态机的比例控制与脉冲微调相结合的方法，在低分辨率编码器和强非线性机械条件下，实现了稳定、精确且可校准的指针式温度显示系统。